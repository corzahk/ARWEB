!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.MergeImage=e()}(this,function(){var t=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}();return function(){function n(t,e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.options=Object.assign({},{backgroundColor:"rgba(0, 0, 0, .7)",lineHeight:20,color:"#fff",fontSize:14,padding:5,imgUrl:"",text:"",width:0},t),!this.options.imgUrl||!this.options.text)throw new Error("The imgUrl and text parameters cannot be empty.");this.callback=e,this.render()}return t(n,[{key:"render",value:function(){var t=this.options,e=t.imgUrl,a=t.width,c=t.text,l=t.fontSize,s=t.padding,h=t.lineHeight,f=t.backgroundColor,n=new Image,g=this;n.src=e,n.setAttribute("crossOrigin","Anonymous"),n.onload=function(){var t=a||this.width,e=this.width/t,n=this.height/e,i=document.createElement("canvas");i.width=t,i.height=n,g.ctx=i.getContext("2d"),g.ctx.drawImage(this,0,0,t,n),g.ctx.fillStyle=f;var r=Math.ceil(g.getStringLength(c)*l/2/(t-2*s)),o=r*l+2*s+(r-1)*(h-l);g.ctx.fillRect(0,n-o,t,o),g.addText(t,n,o),g.callback&&g.callback(i.toDataURL("image/jpeg"))}}},{key:"addText",value:function(t,e,n){var i=this.options,r=i.text,o=i.fontSize,a=i.padding,c=i.lineHeight,l=i.color;this.ctx.font=o+"px 宋体",this.ctx.textBaseline="top",this.ctx.fillStyle=l;for(var s=(t-2*a)/(o/2),h=0;0<this.getStringLength(r);h++){var f=this.cutString(r,s);this.ctx.fillText(r.substr(0,f),a,h*c+e-n+a),r=r.substr(f)}}},{key:"getStringLength",value:function(t){for(var e=t.length,n=0,i=0;i<e;i++)128<t.charCodeAt(i)?n+=2:n+=1;return n}},{key:"cutString",value:function(t,e){for(var n=t.length,i=n,r=0,o=0;o<n;o++)if(128<t.charCodeAt(o)){if(!(r+2<e)){i=o;break}r+=2}else{if(!(r+1<e)){i=o;break}r+=1}return i}}]),n}()});